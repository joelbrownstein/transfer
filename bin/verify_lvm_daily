#!/usr/bin/env bash

while getopts m:o: args
do
    case "${args}" in
        m) mjd=${OPTARG};;
        o) obs=${OPTARG};;
    esac
done


if [ -z "${mjd}" ]; then
    NOW=$(date +"%Y%m%d")
    mjd=$(( ( $(date +%s -d "$NOW") / 86400 ) + 40587 ))
fi

re='^[0-9]{5}$'
if [[ $mjd =~ $re ]]; then
    if [[ "$obs" = "apo" ]]; then
        echo "VERIFY_LVM APO> not supported "
    elif [[ "$obs" = "lco" ]]; then
        done=/home/joelbrownstein/transfer/status/transfer-$mjd.done
        verified=/home/joelbrownstein/transfer/verify/lvm/lco/${mjd}.md5sum.o
        touch_failed=/home/joelbrownstein/transfer/verify/lvm/lco/${mjd}.md5sum.e
        if [ -f "$done" ]; then
            if [ -f "$verified" ]; then
                if [ ! -f "$touch_failed" ]; then
                    failed=`grep FAILED $verified`
                    if [ ! -z "$failed" ]; then
                        touch $touch_failed
                        #subject="FAILED to verify LVM for MJD=$mjd"
                        #from="joelbrownstein@sdss.org"
                        #recipients="admin@sdss.org"
                        #message=`cat $verified`
                        #mail="subject:$subject\nfrom:$from\n$message"
                        #echo -e $mail | sendmail "$recipients"
                    fi
                fi
            else
                echo "DAILY> mjd=$mjd done"
                verify_lvm -m $mjd -f -v
            fi
        else
            echo "VERIFY_LVM> waiting for $done"
        fi
    else
        echo "VERIFY_LVM> invalid observatory: $obs"
    fi
else
    echo "VERIFY_LVM> invalid mjd: $mjd"
fi
