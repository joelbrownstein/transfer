#!/usr/bin/env python3
from sys import exit, argv
from os import getenv
from netrc import netrc
from pyotp import TOTP
def get_credential():
    try: credential = netrc(file = getenv('NETRCFILE'))
    except Exception as e:
        print("TRANSFER_GAUTH> netrc %r" % e)
        credential = None
    return credential
def get_key(host = None, index = None):
    if index in [0,1]:
        credential = get_credential()
        if credential and host:
            authenticators = credential.authenticators(host)
            if authenticators and len(authenticators) == 3:
                key = authenticators[index + 1]
            else:
                print("TRANSFER_GAUTH> cannot find %r in .netrc" % host)
                key = None
        else: key = None
    else: key = None
    return key
if len(argv) > 1 and len(argv) <= 3:
    host = argv[1]
    try: index = int(argv[2]) if len(argv) == 3 else 0
    except: index = None
    key = get_key(host = host, index = index)
    if key:
        if index: print(key)
        else: 
            otp = TOTP(key) if key else None
            if otp: print(otp.now())
    else: exit(1)
else: exit(1)



